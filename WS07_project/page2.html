<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Animaatiot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      .clickable-card {
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .clickable-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      #ruffleContainer {
        position: relative;
        width: 100%;
        min-height: 500px;
        background-color: #000;
      }
      #ruffleContainer ruffle-player {
        width: 100% !important;
        height: 500px !important;
        min-height: 500px !important;
        display: block !important;
      }
      #ruffleContainer ruffle-player canvas {
        width: 100% !important;
        height: auto !important;
        max-width: 100%;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html"><i class="fas fa-home"></i></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="page2.html">Animaatiot</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="page3.html">Pelit</a>
            </li>
          </ul>
          <div class="ms-auto d-flex align-items-center gap-2">
            <!-- Music Player (Navbar - Mobile) -->
            <div id="navbarMusicPlayer" class="d-none">
              <button class="btn btn-sm btn-outline-light" id="navbarPlayerToggle" type="button" data-bs-toggle="collapse" data-bs-target="#navbarPlayerCollapse" aria-expanded="false" aria-controls="navbarPlayerCollapse">
                üéµ
              </button>
              <div class="collapse position-absolute end-0 mt-2" id="navbarPlayerCollapse" style="z-index: 1050; width: 300px; max-width: 90vw;">
                <div class="card shadow-lg">
                  <div class="card-header p-2 d-flex justify-content-between align-items-center">
                    <small class="fw-bold">Music Player</small>
                    <button class="btn btn-sm btn-outline-secondary" id="navbarTogglePlayer" type="button">
                      <span id="navbarToggleIcon">‚àí</span>
                    </button>
                  </div>
                  <div id="navbarPlayerContent">
                    <div class="card-body p-2">
                      <div class="text-center mb-2">
                        <img id="navbarAlbumArt" src="" alt="Album Art" style="width: 120px; height: 120px; object-fit: cover; border-radius: 4px;">
                      </div>
                      <div class="d-flex align-items-center gap-2 mb-2">
                        <button class="btn btn-sm btn-outline-primary" id="navbarPrevBtn" type="button">‚èÆ</button>
                        <button class="btn btn-sm btn-primary" id="navbarPlayPauseBtn" type="button">‚è∏</button>
                        <button class="btn btn-sm btn-outline-primary" id="navbarNextBtn" type="button">‚è≠</button>
                      </div>
                      <div class="d-flex align-items-center gap-2 mb-2">
                        <button class="btn btn-sm btn-outline-secondary" id="navbarMuteBtn" type="button">üîä</button>
                        <input type="range" class="form-range" id="navbarVolumeSlider" min="0" max="100" value="20" style="flex: 1;">
                        <small id="navbarVolumeDisplay" class="text-muted" style="min-width: 35px;">20%</small>
                      </div>
                      <div class="mb-2">
                        <small class="text-muted d-block fw-bold" id="navbarNowPlaying" style="font-size: 0.8em;">Loading...</small>
                        <small class="text-muted d-block" id="navbarTrackInfo" style="font-size: 0.7em;"></small>
                      </div>
                      <div class="border-top pt-2 mt-2">
                        <small class="fw-bold d-block mb-2">Playlist</small>
                        <div id="navbarPlaylist" style="max-height: 150px; overflow-y: auto; font-size: 0.75em;">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <label for="styleSelect" class="me-2" style="color: inherit;">Style:</label>
            <select id="styleSelect" class="form-select form-select-sm" style="width: auto;">
              <option value="tomorrow">Tomorrow</option>
              <option value="yotsuba-b">Yotsuba B</option>
              <option value="yotsubaclassic">Yotsubaclassic</option>
            </select>
            <script>
              // Set dropdown value immediately to prevent browser default
              (function() {
                try {
                  const savedStyle = localStorage.getItem('selectedStyle');
                  if (savedStyle && (savedStyle === 'tomorrow' || savedStyle === 'yotsuba-b' || savedStyle === 'yotsubaclassic')) {
                    const select = document.getElementById('styleSelect');
                    if (select) {
                      select.value = savedStyle;
                    }
                  }
                } catch(e) {}
              })();
            </script>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
      <div class="row">
        <div class="col-12">
          <h1 class="display-4 mb-4">Animaatiot</h1>
          <p class="lead">Valitse animaatio avataksesi sen Ruffle-soittimessa.</p>
        </div>
      </div>
      
      <div class="row mt-4" id="animationsGrid">
        <!-- Animation cards will be generated here -->
      </div>
    </div>

    <!-- Ruffle Player Modal -->
    <div class="modal fade" id="ruffleModal" tabindex="-1" aria-labelledby="ruffleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ruffleModalLabel">Flash Animaatio</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="ruffleContainer">
              <div class="spinner-border text-primary" role="status" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                <span class="visually-hidden">Ladataan...</span>
              </div>
            </div>
            <div id="ruffleDescription" class="mt-3 p-3" style="background-color: rgba(0,0,0,0.05); border-radius: 4px;">
              <p class="mb-0" id="descriptionText">Kuvaus tulee t√§h√§n...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
    <script src="styles.js"></script>
    <script>
      // List of animation files
      const animations = [
        { file: "‚ôÇeveryday‚ôÇuntil‚ôÇukraine‚ôÇis‚ôÇfree‚ôÇ.swf", name: "Everyday Until Ukraine Is Free" },
        { file: "4chancity-craptastrophe.swf", name: "4chan City - Craptastrophe" },
        { file: "4chancity.swf", name: "4chan City" },
        { file: "AllYourBase.swf", name: "All Your Base" },
        { file: "animator_vs__animation.swf", name: "Animator vs Animation" },
        { file: "billmurray.swf", name: "Bill Murray" },
        { file: "dad's_home.swf", name: "Dad's Home" },
        { file: "Drunken_Spartan.swf", name: "Drunken Spartan" },
        { file: "fetafire.swf", name: "Feta Fire" },
        { file: "fliptopbox.swf", name: "Flip Top Box" },
        { file: "hetkily√∂.swf", name: "Hetkily√∂" },
        { file: "im not good with songs.swf", name: "I'm Not Good With Songs" },
        { file: "ITS TIME FOR REVENGE.swf", name: "It's Time For Revenge" },
        { file: "Japan_Break_Industries.swf", name: "Japan Break Industries" },
        { file: "JRA JAPAN WORLD CUP.swf", name: "JRA Japan World Cup" },
        { file: "megaloop3.swf", name: "Mega Loop 3" },
        { file: "MetalGearAwesome.swf", name: "Metal Gear Awesome" },
        { file: "mootykins.swf", name: "Mootykins" },
        { file: "mormon jesus.swf", name: "Mormon Jesus" },
        { file: "roses are red.swf", name: "Roses Are Red" },
        { file: "Shatner_Of_The_Mount.swf", name: "Shatner Of The Mount" },
        { file: "The Golden Age of Video.swf", name: "The Golden Age of Video" },
        { file: "There She is!!.swf", name: "There She Is!!" },
        { file: "ultimateshowdown.swf", name: "Ultimate Showdown" },
        { file: "whatthe.swf", name: "What The" }
      ];

      // Function to fix text colors for Tomorrow theme
      function fixCardTextColors() {
        const selectedStyle = localStorage.getItem('selectedStyle') || 'yotsubaclassic';
        if (selectedStyle === 'tomorrow') {
          // Find all text-muted elements in cards and force light gray color
          const elements = document.querySelectorAll('.clickable-card .text-muted, .clickable-card .card-text.text-muted, .clickable-card small.text-muted, .card .text-muted, .card .card-text.text-muted, .card small.text-muted');
          elements.forEach(el => {
            el.style.setProperty('color', '#c5c8c6', 'important');
            el.classList.remove('text-muted');
            el.classList.add('tomorrow-text');
          });
        } else {
          // Restore text-muted class if not Tomorrow theme
          document.querySelectorAll('.tomorrow-text').forEach(el => {
            el.classList.remove('tomorrow-text');
            el.classList.add('text-muted');
            el.style.removeProperty('color');
          });
        }
      }

      // Generate animation cards
      const grid = document.getElementById('animationsGrid');
      
      animations.forEach((anim) => {
        const col = document.createElement('div');
        col.className = 'col-lg-3 col-md-4 col-sm-6 mb-4';
        const thumbnailPath = `thumbnails/animations/${anim.file.replace('.swf', '.jpg')}`;
        col.innerHTML = `
          <div class="card h-100 clickable-card" style="cursor: pointer;" data-file="${anim.file}" data-name="${anim.name}">
            <div class="card-body d-flex flex-column">
              <h6 class="card-title">${anim.name}</h6>
              <div style="width: 100%; height: 150px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border-radius: 4px; overflow: hidden; position: relative;">
                <img src="${thumbnailPath}" alt="${anim.name}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.parentElement.querySelector('.no-thumb').style.display='flex';" onload="this.style.display='block'; this.parentElement.querySelector('.no-thumb').style.display='none';">
                <div class="no-thumb" style="display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.8em; width: 100%; height: 100%;">No thumbnail</div>
              </div>
              <small class="text-muted">${anim.file}</small>
            </div>
          </div>
        `;
        grid.appendChild(col);
      });
      
      // Fix colors after cards are created and on style changes
      fixCardTextColors();
      
      window.addEventListener('load', function() {
        setTimeout(fixCardTextColors, 100);
      });
      
      window.addEventListener('styleChanged', function() {
        setTimeout(fixCardTextColors, 50);
      });
      
      window.addEventListener('storage', function(e) {
        if (e.key === 'selectedStyle') {
          setTimeout(fixCardTextColors, 50);
        }
      });

      // Modal functionality
      const ruffleModal = new bootstrap.Modal(document.getElementById('ruffleModal'));
      let currentRufflePlayer = null;

      document.querySelectorAll('.clickable-card').forEach(card => {
        card.addEventListener('click', function() {
          const fileName = this.dataset.file;
          const animName = this.dataset.name;
          
          // Update modal title
          document.getElementById('ruffleModalLabel').textContent = animName;
          
          // Update description
          document.getElementById('descriptionText').textContent = `Animaatio: ${animName}`;
          
          // Clear previous player
          const container = document.getElementById('ruffleContainer');
          container.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Ladataan...</span></div>';
          
          // Show modal
          ruffleModal.show();
          
          // Wait for modal to be shown, then load Ruffle
          document.getElementById('ruffleModal').addEventListener('shown.bs.modal', function loadRuffle() {
            // Remove the event listener to avoid multiple loads
            document.getElementById('ruffleModal').removeEventListener('shown.bs.modal', loadRuffle);
            
            // Load Ruffle player using JavaScript API
            const swfUrl = `animations/${fileName}`;
            container.innerHTML = '';
            
            function loadRufflePlayer() {
              if (window.RufflePlayer && window.RufflePlayer.newest) {
                try {
                  const ruffle = window.RufflePlayer.newest();
                  
                  currentRufflePlayer = ruffle.createPlayer();
                  currentRufflePlayer.style.width = '100%';
                  currentRufflePlayer.style.height = '500px';
                  currentRufflePlayer.style.minHeight = '500px';
                  currentRufflePlayer.style.display = 'block';
                  currentRufflePlayer.style.margin = '0 auto';
                  
                  container.innerHTML = '';
                  container.appendChild(currentRufflePlayer);
                  
                  // Load the SWF file
                  currentRufflePlayer.load(swfUrl).then(() => {
                    setTimeout(() => {
                      const canvas = currentRufflePlayer.querySelector('canvas');
                      if (canvas) {
                        canvas.style.display = 'block';
                        canvas.style.margin = '0 auto';
                      }
                    }, 100);
                  }).catch(error => {
                    container.innerHTML = '<div class="alert alert-danger">Virhe animaation lataamisessa. Tarkista, ett√§ tiedosto on saatavilla ja ett√§ k√§yt√§t web-palvelinta (http://localhost:8000).</div>';
                  });
                } catch (error) {
                  // Fallback to object tag
                  container.innerHTML = `<object type="application/x-shockwave-flash" data="${swfUrl}" width="100%" height="500" style="max-width: 100%;">
                    <param name="movie" value="${swfUrl}" />
                    <param name="quality" value="high" />
                    <param name="wmode" value="opaque" />
                  </object>`;
                }
              } else {
                // Retry if Ruffle not loaded yet
                setTimeout(loadRufflePlayer, 100);
              }
            }
            
            loadRufflePlayer();
          }, { once: true });
        });
      });

      // Clean up when modal is closed
      document.getElementById('ruffleModal').addEventListener('hidden.bs.modal', function() {
        if (currentRufflePlayer) {
          try {
            if (currentRufflePlayer.remove) {
              currentRufflePlayer.remove();
            }
          } catch (e) {
            // Ignore cleanup errors
          }
          currentRufflePlayer = null;
        }
        document.getElementById('ruffleContainer').innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Ladataan...</span></div>';
      });
    </script>
  </body>
</html>

